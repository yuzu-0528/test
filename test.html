<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>カレンダー表示</title>
<style>
  body { font-family: sans-serif; padding: 20px; }

  #controls { margin-bottom: 10px; }
  button { padding: 5px 10px; font-size: 14px; margin-right: 5px; }

  #calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    border-top: 1px solid #ccc;
    border-left: 1px solid #ccc;
    width: 100%;
  }

  .weekday, .day {
    border-right: 1px solid #ccc;
    border-bottom: 1px solid #ccc;
    box-sizing: border-box;
  }

  .weekday {
    font-weight: bold;
    text-align: center;
    background: #f0f0f0;
    padding: 5px;
  }

  .weekday.sunday { color: red; }
  .weekday.saturday { color: blue; }

  .day {
    min-height: 140px;
    text-align: left;
    padding: 5px;
    position: relative;
    vertical-align: top;
  }

  .day span.date-num {
    position: absolute;
    top: 5px;
    left: 5px;
    font-size: 20px;
    font-weight: bold;
  }

  .day.sunday span.date-num { color: red; }
  .day.saturday span.date-num { color: blue; }

  .event {
    margin-top: 24px;
    font-size: 13px;
    background-color: #e0f7fa;
    padding: 2px 4px;
    border-radius: 3px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
</style>
</head>
<body>

<h2 id="month-year"></h2>

<div id="controls">
  <button id="prev-month">前の月</button>
  <button id="next-month">次の月</button>
</div>

<div id="calendar"></div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbx1qAtM2Hee80RaulOAButtv97nz6AOv3Zji46V_JYKOrHGvlkBfoxVjnvFZ0E2mWCL/exec";
let currentYear, currentMonth;
let events = [];

// データを取得
async function fetchEvents() {
  try {
    const res = await fetch(GAS_URL);
    events = await res.json();
  } catch (e) {
    console.error("データ取得エラー:", e);
    events = [];
  }
}

// カレンダー表示
function renderCalendar(year, month) {
  const calendar = document.getElementById("calendar");
  calendar.innerHTML = "";

  const firstDate = new Date(year, month, 1);
  currentYear = year;
  currentMonth = month;

  const monthYear = document.getElementById("month-year");
  monthYear.textContent = `${year}年 ${month + 1}月`;

  const weekdays = ["日", "月", "火", "水", "木", "金", "土"];
  weekdays.forEach((w, i) => {
    const header = document.createElement("div");
    header.className = "weekday";
    if (i === 0) header.classList.add("sunday");
    if (i === 6) header.classList.add("saturday");
    header.textContent = w;
    calendar.appendChild(header);
  });

  const startWeekday = firstDate.getDay();
  for (let i = 0; i < startWeekday; i++) {
    const empty = document.createElement("div");
    empty.className = "day";
    calendar.appendChild(empty);
  }

  const totalDays = new Date(year, month + 1, 0).getDate();
  for (let i = 1; i <= totalDays; i++) {
    const div = document.createElement("div");
    div.className = "day";

    const weekday = new Date(year, month, i).getDay();
    if (weekday === 0) div.classList.add("sunday");
    if (weekday === 6) div.classList.add("saturday");

    const dateNum = document.createElement("span");
    dateNum.className = "date-num";
    dateNum.textContent = i;
    div.appendChild(dateNum);

    const dayDate = new Date(year, month, i);

    events.forEach(ev => {
      const start = new Date(ev.start);
      const end = new Date(ev.end);
      if (dayDate >= start && dayDate <= end) {
        const evDiv = document.createElement("div");
        evDiv.className = "event";

        const startTime = start.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
        const endTime = end.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
        evDiv.textContent = `${ev.name} ${startTime}〜${endTime}` + (ev.note ? ` ${ev.note}` : "");
        div.appendChild(evDiv);
      }
    });

    calendar.appendChild(div);
  }
}

document.getElementById("next-month").addEventListener("click", () => {
  let nextMonth = currentMonth + 1;
  let year = currentYear;
  if (nextMonth > 11) {
    nextMonth = 0;
    year++;
  }
  renderCalendar(year, nextMonth);
});

document.getElementById("prev-month").addEventListener("click", () => {
  let prevMonth = currentMonth - 1;
  let year = currentYear;
  if (prevMonth < 0) {
    prevMonth = 11;
    year--;
  }
  renderCalendar(year, prevMonth);
});

(async () => {
  await fetchEvents();
  const today = new Date();
  renderCalendar(today.getFullYear(), today.getMonth());
})();
</script>

</body>
</html>
